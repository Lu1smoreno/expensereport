<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#172b4d">
<title>ExpenseFlow — Schaeffler Gestión de Gastos</title>
<link rel="manifest" href="data:application/json,{}">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<link href="https://unpkg.com/lucide-static@0.263.1/font/lucide.css" rel="stylesheet">
<script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
<style>
:root {
  --bg-primary: #f0f2f5;
  --bg-secondary: #ffffff;
  --bg-card: #ffffff;
  --bg-input: #f7f8fa;
  --bg-elevated: #f0f2f5;
  --accent: #0052cc;
  --accent-light: #4c9aff;
  --accent-glow: rgba(0, 82, 204, 0.08);
  --accent-hover: #0065ff;
  --accent-subtle: #e9f0ff;
  --success: #1b8a5a;
  --success-bg: #e6f4ed;
  --warning: #b8860b;
  --warning-bg: #fef6e0;
  --danger: #c9372c;
  --danger-bg: #ffecea;
  --text-primary: #172b4d;
  --text-secondary: #5e6c84;
  --text-muted: #97a0af;
  --border: #dfe1e6;
  --border-focus: #0052cc;
  --radius: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.04);
  --shadow: 0 2px 8px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
  --shadow-lg: 0 8px 24px rgba(0,0,0,0.08);
  --shadow-xl: 0 16px 48px rgba(0,0,0,0.12);
  --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  --font: 'DM Sans', -apple-system, sans-serif;
  --font-mono: 'Space Mono', monospace;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: var(--font);
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  min-height: 100dvh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

/* ===== APP CONTAINER ===== */
.app-container {
  max-width: 480px;
  margin: 0 auto;
  min-height: 100vh;
  min-height: 100dvh;
  background: var(--bg-primary);
  position: relative;
}

/* ===== HEADER ===== */
.header {
  padding: 14px 20px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(255,255,255,0.85);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
}

.logo {
  display: flex;
  align-items: center;
  gap: 8px;
}

.logo-icon {
  width: 32px;
  height: 32px;
  border-radius: 10px;
  background: var(--accent);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
}

.logo-text {
  font-size: 17px;
  font-weight: 700;
  color: var(--text-primary);
  letter-spacing: -0.3px;
}

.logo-text span { color: var(--accent); }

.header-actions { display: flex; gap: 4px; }

.btn-icon {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
}

.btn-icon:hover { background: var(--bg-elevated); color: var(--text-primary); }

/* ===== TRANSITIONS ===== */
.btn, .nav-item, .expense-item, .dash-pill, .dash-top-item, .settings-item, .capture-btn {
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
  user-select: none;
}

/* ===== SCREENS ===== */
main {
  padding: 16px 16px 100px;
}

.screen { display: none; }
.screen.active { display: block; animation: fadeIn 0.25s ease; }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

/* ===== BACK ROW ===== */
.back-row {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
}

.back-btn {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--bg-card);
  color: var(--text-primary);
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
  box-shadow: var(--shadow-sm);
}

.back-btn:hover { border-color: var(--accent); }

.screen-title {
  font-size: 18px;
  font-weight: 700;
  letter-spacing: -0.3px;
}

/* ===== WELCOME CARD ===== */
.welcome-card {
  background: linear-gradient(135deg, #0052cc, #2684ff);
  border-radius: var(--radius-xl);
  padding: 24px;
  margin-bottom: 20px;
  position: relative;
  overflow: hidden;
  color: white;
  box-shadow: 0 4px 16px rgba(0, 82, 204, 0.25);
}

.welcome-card::before {
  content: '';
  position: absolute;
  top: -40%;
  right: -20%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle at 70% 30%, rgba(255,255,255,0.1), transparent 50%);
  pointer-events: none;
}

.welcome-greeting {
  font-size: 14px;
  font-weight: 500;
  opacity: 0.85;
  margin-bottom: 2px;
}

.welcome-name {
  font-size: 22px;
  font-weight: 700;
  letter-spacing: -0.3px;
  margin-bottom: 16px;
}

.welcome-stats {
  display: flex;
  gap: 20px;
}

.stat-box { text-align: left; }

.stat-value {
  font-family: var(--font-mono);
  font-size: 20px;
  font-weight: 700;
  display: block;
}

.stat-label {
  font-size: 11px;
  opacity: 0.75;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-top: 2px;
}

/* ===== QUICK ACTIONS ===== */
.quick-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 20px;
}

.action-btn {
  padding: 14px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: var(--bg-card);
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: var(--shadow-sm);
}

.action-btn:hover { border-color: var(--accent); box-shadow: var(--shadow); }

.action-btn .icon {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  color: var(--accent);
  background: var(--accent-subtle);
}

.action-btn .text {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
}

/* ===== SECTION TITLE ===== */
.section-title {
  font-size: 13px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

/* ===== EXPENSE LIST ===== */
.expense-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.expense-item {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  transition: var(--transition);
  animation: slideUp 0.3s ease backwards;
  box-shadow: var(--shadow-sm);
}

.expense-item:hover {
  border-color: var(--accent);
  box-shadow: var(--shadow);
  transform: translateY(-1px);
}

.expense-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  color: white;
}

.expense-icon.comida { background: #f97316; }
.expense-icon.transporte { background: #3b82f6; }
.expense-icon.hotel { background: #8b5cf6; }
.expense-icon.combustible { background: #10b981; }
.expense-icon.parking { background: #eab308; }
.expense-icon.peaje { background: #ef4444; }

.expense-info {
  flex: 1;
  min-width: 0;
}

.expense-provider {
  font-size: 14px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--text-primary);
}

.expense-meta {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 2px;
}

.expense-right {
  text-align: right;
  flex-shrink: 0;
}

.expense-amount {
  font-family: var(--font-mono);
  font-size: 15px;
  font-weight: 700;
  color: var(--text-primary);
}

.expense-status {
  font-size: 10px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 6px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  display: inline-block;
  margin-top: 4px;
}

.expense-status.success { background: var(--success-bg); color: var(--success); }
.expense-status.warning { background: var(--warning-bg); color: var(--warning); }
.expense-status.neutral { background: var(--bg-elevated); color: var(--text-muted); }
.expense-status.error { background: var(--danger-bg); color: var(--danger); }

/* ===== EMPTY STATE ===== */
.empty-state {
  text-align: center;
  padding: 48px 20px;
  color: var(--text-muted);
}

.empty-state .icon { margin-bottom: 12px; }

.empty-state .title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 4px;
}

.empty-state .subtitle {
  font-size: 13px;
}

/* ===== CAPTURE ZONE ===== */
.capture-zone {
  border: 2px dashed var(--border);
  border-radius: var(--radius-xl);
  padding: 40px 20px;
  text-align: center;
  cursor: pointer;
  transition: var(--transition);
  background: var(--bg-card);
}

.capture-zone:hover,
.capture-zone.dragover {
  border-color: var(--accent);
  background: var(--accent-glow);
}

.capture-zone .icon { margin-bottom: 12px; color: var(--accent); }

.capture-zone .title {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.capture-zone .subtitle {
  font-size: 12px;
  color: var(--text-muted);
}

.capture-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 12px;
}

.capture-btn {
  padding: 14px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: var(--bg-card);
  color: var(--text-primary);
  font-family: var(--font);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  box-shadow: var(--shadow-sm);
}

.capture-btn:hover { border-color: var(--accent); box-shadow: var(--shadow); }
.capture-btn .icon { font-size: 18px; color: var(--accent); }

/* ===== OCR PROCESSING ===== */
.ocr-processing {
  display: none;
  text-align: center;
  padding: 40px 20px;
}

.ocr-processing.active { display: block; }

.ocr-spinner {
  width: 48px;
  height: 48px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  margin: 0 auto 16px;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.ocr-processing .title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 4px;
}

.ocr-processing .subtitle {
  font-size: 13px;
  color: var(--text-muted);
  margin-bottom: 16px;
}

.ocr-progress {
  height: 4px;
  background: var(--bg-elevated);
  border-radius: 2px;
  overflow: hidden;
  max-width: 200px;
  margin: 0 auto;
}

.ocr-progress-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--accent-light));
  border-radius: 2px;
  transition: width 0.3s ease;
}

/* ===== FORM ===== */
.form-section {
  margin-bottom: 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 16px;
  box-shadow: var(--shadow-sm);
}

.form-section-title {
  font-size: 12px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 12px;
}

.form-section-title svg { color: var(--text-muted); }

.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.form-grid .full { grid-column: 1 / -1; }

.form-group { display: flex; flex-direction: column; gap: 4px; }

.form-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 6px;
}

.auto-badge {
  font-size: 9px;
  font-weight: 700;
  background: var(--accent-subtle);
  color: var(--accent);
  padding: 1px 5px;
  border-radius: 4px;
  display: none;
  letter-spacing: 0.5px;
}

.form-input, .form-select {
  width: 100%;
  padding: 11px 14px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-primary);
  font-family: var(--font);
  font-size: 14px;
  transition: var(--transition);
  outline: none;
}

.form-input:focus, .form-select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.1);
  background: white;
}

.form-input.auto-filled {
  border-color: rgba(0, 82, 204, 0.3);
  background: var(--accent-subtle);
}

.form-select { cursor: pointer; appearance: auto; }

textarea.form-input { resize: vertical; min-height: 60px; }

.form-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 16px;
}

/* ===== CONFIDENCE BAR ===== */
.confidence-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 12px;
  font-size: 12px;
  color: var(--text-muted);
  background: var(--bg-card);
  padding: 10px 14px;
  border-radius: 10px;
  border: 1px solid var(--border);
}

.confidence-bar .label { white-space: nowrap; font-weight: 500; }

.confidence-track {
  flex: 1;
  height: 6px;
  background: var(--bg-elevated);
  border-radius: 3px;
  overflow: hidden;
}

.confidence-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.5s ease;
}

.confidence-fill.high { background: var(--success); }
.confidence-fill.medium { background: var(--warning); }
.confidence-fill.low { background: var(--danger); }

.confidence-value {
  font-family: var(--font-mono);
  font-weight: 700;
  font-size: 13px;
  min-width: 32px;
  text-align: right;
}

/* ===== TICKET PREVIEW ===== */
.ticket-preview {
  width: 100%;
  max-height: 180px;
  object-fit: contain;
  border-radius: var(--radius);
  margin-bottom: 12px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
}

/* ===== BUTTONS ===== */
.btn {
  padding: 12px 20px;
  border-radius: 10px;
  border: none;
  font-family: var(--font);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn-primary {
  background: var(--accent);
  color: white;
  box-shadow: 0 2px 8px rgba(0, 82, 204, 0.25);
}

.btn-primary:hover {
  background: var(--accent-hover);
  box-shadow: 0 4px 16px rgba(0, 82, 204, 0.35);
  transform: translateY(-1px);
}

.btn-secondary {
  background: var(--bg-card);
  color: var(--text-primary);
  border: 1px solid var(--border);
}

.btn-secondary:hover { border-color: var(--accent); background: var(--accent-subtle); }

.btn-danger {
  background: var(--danger);
  color: white;
}

.btn-danger:hover { opacity: 0.9; }

.btn-full { width: 100%; }

/* ===== POLICY ALERTS ===== */
.policy-alert {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 14px;
  border-radius: 10px;
  font-size: 13px;
  margin-bottom: 10px;
}

.policy-alert.warning {
  background: var(--warning-bg);
  color: var(--warning);
  border: 1px solid rgba(184, 134, 11, 0.2);
}

.policy-alert.error {
  background: var(--danger-bg);
  color: var(--danger);
  border: 1px solid rgba(201, 55, 44, 0.2);
}

.policy-alert .icon { flex-shrink: 0; }

/* ===== SETTINGS ===== */
.settings-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 16px;
  margin-bottom: 8px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow-sm);
}

.settings-item:last-child { margin-bottom: 0; }

.settings-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.settings-icon {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  background: var(--accent-subtle);
  color: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
}

.settings-label {
  font-size: 14px;
  font-weight: 600;
}

.settings-desc {
  font-size: 12px;
  color: var(--text-muted);
}

.toggle {
  width: 44px;
  height: 26px;
  border-radius: 13px;
  border: none;
  background: var(--border);
  cursor: pointer;
  position: relative;
  transition: var(--transition);
}

.toggle::after {
  content: '';
  position: absolute;
  top: 3px;
  left: 3px;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: white;
  transition: var(--transition);
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.toggle.active {
  background: var(--accent);
}

.toggle.active::after {
  left: 21px;
}

/* ===== TOAST ===== */
.toast {
  position: fixed;
  bottom: 90px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--text-primary);
  color: white;
  padding: 12px 20px;
  border-radius: var(--radius);
  font-size: 13px;
  font-weight: 500;
  box-shadow: var(--shadow-xl);
  z-index: 1000;
  opacity: 0;
  transition: all 0.3s ease;
  pointer-events: none;
  display: flex;
  align-items: center;
  gap: 8px;
  max-width: calc(100vw - 40px);
}

.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }
.toast.warning { background: var(--warning); color: var(--text-primary); }

/* ===== MODAL ===== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(23, 43, 77, 0.5);
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
  z-index: 200;
  display: none;
  align-items: flex-end;
  justify-content: center;
}

.modal-overlay.show { display: flex; }

.modal-content {
  width: 100%;
  max-width: 480px;
  max-height: 85vh;
  background: var(--bg-card);
  border-radius: var(--radius-xl) var(--radius-xl) 0 0;
  padding: 24px 20px;
  overflow-y: auto;
  animation: slideUp 0.3s ease;
  box-shadow: var(--shadow-xl);
}

.modal-handle {
  width: 36px;
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  margin: 0 auto 16px;
}

/* ===== BOTTOM NAV ===== */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 480px;
  background: rgba(255,255,255,0.9);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid var(--border);
  display: flex;
  padding: 8px 16px;
  padding-bottom: max(8px, env(safe-area-inset-bottom));
  z-index: 100;
}

.nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  padding: 6px;
  border-radius: 10px;
  border: none;
  background: transparent;
  color: var(--text-muted);
  font-family: var(--font);
  font-size: 10px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
}

.nav-item.active { color: var(--accent); }
.nav-item .icon { font-size: 20px; display: flex; }
.nav-item .label { font-size: 10px; }

/* ===== DASHBOARD COMPACT ===== */
.dash-header {
  background: linear-gradient(135deg, #0052cc, #2684ff);
  border-radius: var(--radius-xl);
  padding: 18px 20px 14px;
  margin-bottom: 16px;
  color: white;
  box-shadow: 0 4px 16px rgba(0, 82, 204, 0.25);
}

.dash-header-top {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 14px;
}

.dash-header-label {
  font-size: 10px;
  opacity: 0.7;
  letter-spacing: 1px;
  font-weight: 600;
  margin-bottom: 2px;
}

.dash-header-total {
  font-family: var(--font-mono);
  font-size: 28px;
  font-weight: 700;
  letter-spacing: -1px;
}

.dash-period-pills {
  display: flex;
  gap: 3px;
  background: rgba(0,0,0,0.15);
  border-radius: 8px;
  padding: 3px;
}

.dash-pill {
  width: 30px;
  height: 26px;
  border-radius: 6px;
  border: none;
  background: transparent;
  color: rgba(255,255,255,0.6);
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
}

.dash-pill.active {
  background: rgba(255,255,255,0.2);
  color: white;
}

.dash-mini-kpis {
  display: flex;
  align-items: center;
  justify-content: space-around;
  padding-top: 12px;
  border-top: 1px solid rgba(255,255,255,0.15);
}

.dash-mini-kpi {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1px;
}

.dash-mini-val {
  font-family: var(--font-mono);
  font-size: 18px;
  font-weight: 700;
}

.dash-mini-val.success { color: #86efac; }
.dash-mini-val.warning { color: #fde68a; }
.dash-mini-val.danger { color: #fca5a5; }

.dash-mini-lbl { font-size: 10px; opacity: 0.6; }
.dash-mini-sep { width: 1px; height: 24px; background: rgba(255,255,255,0.15); }

/* Donut section */
.dash-donut-section {
  display: flex;
  align-items: center;
  gap: 14px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 14px;
  margin-bottom: 14px;
  box-shadow: var(--shadow-sm);
}

.dash-donut-center {
  position: relative;
  width: 130px;
  height: 130px;
  flex-shrink: 0;
}

.dash-donut-center canvas { max-width: 130px !important; max-height: 130px !important; }

.dash-donut-inner {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  pointer-events: none;
}

.dash-donut-inner-label {
  font-size: 9px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.dash-donut-inner-value {
  font-family: var(--font-mono);
  font-size: 14px;
  font-weight: 700;
}

.dash-cat-legend {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 5px;
  min-width: 0;
}

.dash-legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; }
.dash-legend-dot { width: 8px; height: 8px; border-radius: 2px; flex-shrink: 0; }
.dash-legend-label { flex: 1; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.dash-legend-pct { font-family: var(--font-mono); font-size: 10px; color: var(--text-muted); min-width: 28px; text-align: right; }
.dash-legend-value { font-family: var(--font-mono); font-size: 11px; font-weight: 700; white-space: nowrap; min-width: 50px; text-align: right; }

/* Section heads */
.dash-section-head {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.3px;
  margin-bottom: 8px;
}

.dash-see-all {
  background: none;
  border: none;
  color: var(--accent);
  font-family: var(--font);
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 4px;
}

.dash-see-all:hover { background: var(--accent-subtle); }

/* Top list */
.dash-top-list { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }

.dash-top-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  cursor: pointer;
  transition: var(--transition);
  box-shadow: var(--shadow-sm);
}

.dash-top-item:hover { border-color: var(--accent); box-shadow: var(--shadow); }

.dash-top-icon {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 15px;
  flex-shrink: 0;
  color: white;
}

.dash-top-info { flex: 1; min-width: 0; }
.dash-top-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.dash-top-meta { font-size: 10px; color: var(--text-muted); }
.dash-top-amount { font-family: var(--font-mono); font-size: 14px; font-weight: 700; white-space: nowrap; }

/* Sparkline */
.dash-spark-section { margin-bottom: 10px; }

.dash-spark-wrap {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px 12px 6px;
  height: 100px;
  box-shadow: var(--shadow-sm);
}

.dash-spark-wrap canvas { max-height: 80px !important; }

/* ===== SYNC STATUS ===== */
.sync-badge {
  font-size: 10px;
  font-weight: 700;
  padding: 3px 8px;
  border-radius: 6px;
  letter-spacing: 0.5px;
}

.sync-badge.offline { background: var(--bg-elevated); color: var(--text-muted); }
.sync-badge.online { background: var(--success-bg); color: var(--success); }
.sync-badge.syncing { background: var(--accent-subtle); color: var(--accent); animation: pulse 1.5s infinite; }
.sync-badge.error { background: var(--danger-bg); color: var(--danger); }

@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

/* ===== HIDDEN ===== */
.hidden { display: none !important; }

#fileInput, #cameraInput { display: none; }
</style>
<body>

<div class="app-container">
  <!-- HEADER -->
  <header class="header">
    <div class="logo">
      <div class="logo-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg></div>
      <div class="logo-text">Expense<span>Flow</span></div>
    </div>
    <div class="header-actions">
      <button class="btn-icon" onclick="toggleLang()" title="ES/EN" id="langBtn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg></button>
      <button class="btn-icon" onclick="showScreen('settings')" title="Settings"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="main-content">

    <!-- ===== HOME SCREEN ===== -->
    <div id="screen-home" class="screen active">
      <div class="welcome-card">
        <div class="welcome-greeting" data-i18n="welcome_greeting">Buenos días</div>
        <div class="welcome-name" id="userName">Usuario</div>
        <div class="welcome-stats">
          <div class="stat-box">
            <div class="stat-label" data-i18n="this_month">Este mes</div>
            <div class="stat-value" id="totalMonth">0,00 €</div>
          </div>
          <div class="stat-box">
            <div class="stat-label" data-i18n="pending_approval">Pendientes</div>
            <div class="stat-value warning" id="pendingCount">0</div>
          </div>
        </div>
      </div>

      <button class="new-expense-btn" onclick="showScreen('capture')">
        <span class="icon nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></span>
        <span data-i18n="new_expense">Nuevo Gasto</span>
      </button>

      <div class="section-title">
        <span data-i18n="recent_expenses">Gastos recientes</span>
      </div>

      <div class="expense-list" id="expenseList">
        <div class="empty-state" id="emptyState">
          <div class="icon" style="opacity:0.3"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg></div>
          <p data-i18n="no_expenses">No hay gastos registrados aún.<br>Pulsa "Nuevo Gasto" para empezar.</p>
        </div>
      </div>
    </div>

    <!-- ===== CAPTURE SCREEN ===== -->
    <div id="screen-capture" class="screen">
      <div class="back-row">
        <button class="back-btn" onclick="showScreen('home')">←</button>
        <div class="screen-title" data-i18n="capture_title">Capturar ticket</div>
      </div>

      <div id="captureZone" class="capture-zone" onclick="document.getElementById('fileInput').click()">
        <span class="icon" style="font-size:40px;color:var(--accent);"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></span>
        <div class="title" data-i18n="capture_instruction">Sube o arrastra tu ticket</div>
        <div class="subtitle" data-i18n="capture_formats">JPG, PNG o PDF · Máx 10MB</div>
      </div>

      <div class="capture-buttons">
        <button class="capture-btn" onclick="document.getElementById('cameraInput').click()">
          <span class="icon nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></span>
          <span data-i18n="take_photo">Hacer foto</span>
        </button>
        <button class="capture-btn" onclick="document.getElementById('fileInput').click()">
          <span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></span>
          <span data-i18n="choose_file">Elegir archivo</span>
        </button>
      </div>

      <input type="file" id="fileInput" accept="image/*,.pdf" onchange="handleFileSelect(event)">
      <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handleFileSelect(event)">

      <div id="ocrProcessing" class="ocr-processing">
        <div class="ocr-spinner"></div>
        <div class="title" data-i18n="ocr_processing">Analizando ticket...</div>
        <div class="subtitle" data-i18n="ocr_extracting">Extrayendo datos automáticamente</div>
        <div class="ocr-progress">
          <div class="ocr-progress-bar" id="ocrProgressBar"></div>
        </div>
      </div>
    </div>

    <!-- ===== EXPENSE FORM ===== -->
    <div id="screen-form" class="screen">
      <div class="back-row">
        <button class="back-btn" onclick="showScreen('capture')">←</button>
        <div class="screen-title" data-i18n="expense_detail">Detalle del gasto</div>
      </div>

      <img id="ticketPreview" class="ticket-preview hidden" alt="Ticket">

      <div class="confidence-bar" id="confidenceBar">
        <span class="label" data-i18n="ocr_confidence">Fiabilidad OCR</span>
        <div class="confidence-track">
          <div class="confidence-fill" id="confidenceFill"></div>
        </div>
        <span class="confidence-value" id="confidenceValue">—</span>
      </div>

      <div id="policyAlerts"></div>

      <form id="expenseForm" onsubmit="submitExpense(event)" novalidate>
        <div class="form-section">
          <div class="form-section-title">
            <span style="opacity:0.6"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></span>
            <span data-i18n="basic_info">Información básica</span>
          </div>
          <div class="form-grid">
            <div class="form-group full">
              <label class="form-label">
                <span data-i18n="provider">Proveedor</span>
                <span class="auto-badge" id="badge-provider" data-i18n="auto">AUTO</span>
              </label>
              <input type="text" class="form-input" id="inputProvider" placeholder="Ej: Restaurante La Tasca" required>
            </div>
            <div class="form-group">
              <label class="form-label">
                <span data-i18n="date">Fecha</span>
                <span class="auto-badge" id="badge-date" data-i18n="auto">AUTO</span>
              </label>
              <input type="date" class="form-input" id="inputDate" required>
            </div>
            <div class="form-group">
              <label class="form-label">
                <span data-i18n="category">Categoría</span>
                <span class="auto-badge" id="badge-category" data-i18n="auto">AUTO</span>
              </label>
              <select class="form-select" id="inputCategory">
                <option value="">—</option>
                <option value="comida">Comida</option>
                <option value="transporte">Transporte</option>
                <option value="hotel">Hotel</option>
                <option value="combustible">Combustible</option>
                <option value="parking">Parking</option>
                <option value="peaje">Peaje</option>
              </select>
            </div>
          </div>
        </div>
<div class="form-section">
          <div class="form-section-title">
            <span style="opacity:0.6"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></span>
            <span data-i18n="location_tax">Localización y Fiscalidad</span>
          </div>
          <div class="form-grid">
            <div class="form-group full">
              <label class="form-label">
                <span data-i18n="address">Dirección</span>
                <span class="auto-badge" id="badge-address" data-i18n="auto">AUTO</span>
              </label>
              <input type="text" class="form-input" id="inputAddress" placeholder="Ej: Calle Mayor 15">
            </div>
            <div class="form-group">
              <label class="form-label">
                <span data-i18n="city">Ciudad</span>
                <span class="auto-badge" id="badge-city" data-i18n="auto">AUTO</span>
              </label>
              <input type="text" class="form-input" id="inputCity" placeholder="Ej: Madrid">
            </div>
            <div class="form-group">
              <label class="form-label">
                <span data-i18n="tax_id">NIF / Tax ID</span>
                <span class="auto-badge" id="badge-taxId" data-i18n="auto">AUTO</span>
              </label>
              <input type="text" class="form-input" id="inputTaxId" placeholder="Ej: B12345678">
            </div>
          </div>
        </div>
        
        <div class="form-section">
          <div class="form-section-title">
            <span style="opacity:0.6"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></span>
            <span data-i18n="amounts">Importes</span>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">
                <span data-i18n="total_amount">Total (€)</span>
                <span class="auto-badge" id="badge-total" data-i18n="auto">AUTO</span>
              </label>
              <input type="number" step="0.01" class="form-input" id="inputTotal" placeholder="0,00" required>
            </div>
            <div class="form-group">
              <label class="form-label">
                <span data-i18n="vat">IVA (€)</span>
                <span class="auto-badge" id="badge-vat" data-i18n="auto">AUTO</span>
              </label>
              <input type="number" step="0.01" class="form-input" id="inputVAT" placeholder="0,00">
            </div>
            <div class="form-group">
              <label class="form-label" data-i18n="vat_rate">Tipo IVA (%)</label>
              <select class="form-select" id="inputVATRate">
                <option value="">—</option>
                <option value="21">21%</option>
                <option value="10">10%</option>
                <option value="4">4%</option>
                <option value="0">0% / Exento</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" data-i18n="payment_method">Método pago</label>
              <select class="form-select" id="inputPayment">
                <option value="tarjeta_corp">Tarjeta corporativa</option>
                <option value="tarjeta_propia">Tarjeta propia</option>
                <option value="efectivo">Efectivo</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-title">
            <span style="opacity:0.6"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg></span>
            <span data-i18n="additional">Adicional</span>
          </div>
          <div class="form-group">
            <label class="form-label" data-i18n="notes">Notas / Comentarios</label>
            <textarea class="form-input" id="inputNotes" rows="2" placeholder="Opcional..."></textarea>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="saveDraft()">
            <span><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg></span>
            <span data-i18n="save_draft">Borrador</span>
          </button>
          <button type="submit" class="btn btn-primary">
            <span><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></span>
            <span data-i18n="submit">Enviar</span>
          </button>
        </div>
      </form>
    </div>

    <!-- ===== SETTINGS SCREEN ===== -->
    <div id="screen-settings" class="screen">
      <div class="back-row">
        <button class="back-btn" onclick="showScreen('home')">←</button>
        <div class="screen-title" data-i18n="settings">Ajustes</div>
      </div>

      <div class="form-group" style="margin-bottom: 12px;">
        <label class="form-label" data-i18n="your_name">Tu nombre</label>
        <input type="text" class="form-input" id="settingsName" placeholder="Nombre y apellido" onchange="saveName()">
      </div>

      <div class="form-group" style="margin-bottom: 20px;">
        <label class="form-label" data-i18n="your_email">Tu email corporativo</label>
        <input type="email" class="form-input" id="settingsEmail" placeholder="nombre@schaeffler.com" onchange="saveEmail()">
      </div>

      <!-- CLOUD SYNC -->
      <div class="section-title" style="margin-top: 24px;">
        <span data-i18n="cloud_sync">Sincronización en la nube</span>
      </div>

      <div class="settings-item" id="syncStatusCard">
        <div class="settings-info">
          <div class="settings-icon" id="syncIcon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg></div>
          <div>
            <div class="settings-label" id="syncStatusLabel" data-i18n="sync_not_configured">No configurado</div>
            <div class="settings-desc" id="syncStatusDesc" data-i18n="sync_desc">Conecta Power Automate para sincronizar</div>
          </div>
        </div>
        <div id="syncBadge" class="sync-badge offline">OFF</div>
      </div>

      <div class="form-group" style="margin-top: 12px;">
        <label class="form-label" style="color: var(--accent);" data-i18n="ocr_url">URL del Motor OCR (AI Builder)</label>
        <input type="url" class="form-input" id="settingsOcrUrl" placeholder="https://prod-xx..." onchange="saveOcrUrl()">
        <div style="font-size:11px;color:var(--text-muted);margin-top:4px;" data-i18n="ocr_url_help">Pega aquí la URL HTTP POST del flujo que lee los tickets</div>
      </div>
      
      <div class="form-group" style="margin-top: 12px;">
        <label class="form-label" data-i18n="flow_url">URL del flujo de Power Automate</label>
        <input type="url" class="form-input" id="settingsFlowUrl" placeholder="https://prod-xx.westeurope.logic.azure.com/..." onchange="saveFlowUrl()">
        <div style="font-size:11px;color:var(--text-muted);margin-top:4px;" data-i18n="flow_url_help">Pega aquí la URL HTTP POST de tu flujo</div>
      </div>

      <button class="btn btn-primary btn-full" onclick="testCloudSync()" style="margin-top: 10px;" id="btnTestSync">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>
        <span data-i18n="test_sync">Probar conexión</span>
      </button>

      <div class="settings-item">
        <div class="settings-info">
          <div class="settings-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg></div>
          <div>
            <div class="settings-label" data-i18n="language">Idioma</div>
            <div class="settings-desc" id="currentLang">Español</div>
          </div>
        </div>
        <button class="toggle" id="langToggle" onclick="toggleLang()"></button>
      </div>

      <div class="settings-item">
        <div class="settings-info">
          <div class="settings-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg></div>
          <div>
            <div class="settings-label" data-i18n="notifications">Notificaciones</div>
            <div class="settings-desc" data-i18n="notif_desc">Push y email</div>
          </div>
        </div>
        <button class="toggle active"></button>
      </div>

      <div class="section-title" style="margin-top: 24px;">
        <span data-i18n="policies">Políticas de gasto</span>
      </div>

      <div id="policySettings">
        <div class="settings-item">
          <div class="settings-info">
            <div class="settings-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg></div>
            <div>
              <div class="settings-label" data-i18n="cat_food">Comidas</div>
              <div class="settings-desc" data-i18n="limit">Límite diario</div>
            </div>
          </div>
          <span style="font-family: var(--font-mono); color: var(--accent);">50 €</span>
        </div>
        <div class="settings-item">
          <div class="settings-info">
            <div class="settings-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21V7a2 2 0 0 1 2-2h6"/><path d="M13 21V3a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v18"/><path d="M7 10h0M7 14h0M17 7h0M17 11h0M17 15h0"/></svg></div>
            <div>
              <div class="settings-label" data-i18n="cat_hotel">Hotel</div>
              <div class="settings-desc" data-i18n="limit_night">Límite por noche</div>
            </div>
          </div>
          <span style="font-family: var(--font-mono); color: var(--accent);">120 €</span>
        </div>
        <div class="settings-item">
          <div class="settings-info">
            <div class="settings-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 17h14v-5H5z"/><path d="M2 17h20l-2-8H4z"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></svg></div>
            <div>
              <div class="settings-label" data-i18n="cat_transport">Transporte</div>
              <div class="settings-desc" data-i18n="limit_trip">Límite por viaje</div>
            </div>
          </div>
          <span style="font-family: var(--font-mono); color: var(--accent);">80 €</span>
        </div>
      </div>

      <div class="section-title" style="margin-top: 24px;">
        <span data-i18n="data_export">Exportar datos</span>
      </div>
      <button class="btn btn-secondary btn-full" onclick="exportToCSV()" style="margin-top: 8px;">
        <span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></span>
        <span data-i18n="export_csv">Exportar a CSV (Excel)</span>
      </button>
    </div>

    <!-- ===== DASHBOARD SCREEN ===== -->
    <div id="screen-dashboard" class="screen">

      <!-- Header with total and period -->
      <div class="dash-header">
        <div class="dash-header-top">
          <div>
            <div class="dash-header-label" data-i18n="dash_this_period">ESTE MES</div>
            <div class="dash-header-total" id="dashTotalSpend">0,00 €</div>
          </div>
          <div class="dash-period-pills">
            <button class="dash-pill active" data-period="month" onclick="setDashPeriod('month')">M</button>
            <button class="dash-pill" data-period="quarter" onclick="setDashPeriod('quarter')">T</button>
            <button class="dash-pill" data-period="year" onclick="setDashPeriod('year')">A</button>
            <button class="dash-pill" data-period="all" onclick="setDashPeriod('all')">∞</button>
          </div>
        </div>
        <!-- Mini KPI row -->
        <div class="dash-mini-kpis">
          <div class="dash-mini-kpi">
            <span class="dash-mini-val" id="dashCount">0</span>
            <span class="dash-mini-lbl" data-i18n="dash_expenses">Gastos</span>
          </div>
          <div class="dash-mini-sep"></div>
          <div class="dash-mini-kpi">
            <span class="dash-mini-val success" id="dashApproved">0</span>
            <span class="dash-mini-lbl"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#34d399" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg></span>
          </div>
          <div class="dash-mini-sep"></div>
          <div class="dash-mini-kpi">
            <span class="dash-mini-val warning" id="dashPending">0</span>
            <span class="dash-mini-lbl"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></span>
          </div>
          <div class="dash-mini-sep"></div>
          <div class="dash-mini-kpi">
            <span class="dash-mini-val danger" id="dashPolicyBreaks">0</span>
            <span class="dash-mini-lbl"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/></svg></span>
          </div>
        </div>
      </div>

      <!-- Donut + Category Legend (main visual) -->
      <div class="dash-donut-section">
        <div class="dash-donut-center">
          <canvas id="chartCategory" width="160" height="160"></canvas>
          <div class="dash-donut-inner">
            <div class="dash-donut-inner-label" data-i18n="dash_avg_expense">Media</div>
            <div class="dash-donut-inner-value" id="dashAvg">0 €</div>
          </div>
        </div>
        <div class="dash-cat-legend" id="categoryLegend"></div>
      </div>

      <!-- Top expenses (compact list like the reference image) -->
      <div class="dash-section-head">
        <span data-i18n="dash_top_expenses">Top gastos</span>
        <button class="dash-see-all" onclick="exportDashPDF()" data-i18n="dash_export_report"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg> PDF</button>
      </div>
      <div class="dash-top-list" id="topProviders"></div>

      <!-- Mini bar chart (sparkline-like monthly trend) -->
      <div class="dash-spark-section">
        <div class="dash-section-head">
          <span data-i18n="dash_monthly_trend">Evolución</span>
          <button class="dash-see-all" onclick="exportToCSV()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg> CSV</button>
        </div>
        <div class="dash-spark-wrap">
          <canvas id="chartMonthly" height="80"></canvas>
        </div>
      </div>

    </div>

  </main>

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav">
    <button class="nav-item active" data-screen="home" onclick="showScreen('home')">
      <span class="icon nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></span>
      <span class="label" data-i18n="nav_home">Inicio</span>
    </button>
    <button class="nav-item" data-screen="capture" onclick="showScreen('capture')">
      <span class="icon nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></span>
      <span class="label" data-i18n="nav_capture">Capturar</span>
    </button>
    <button class="nav-item" data-screen="dashboard" onclick="showScreen('dashboard')">
      <span class="icon nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></span>
      <span class="label" data-i18n="nav_dashboard">Dashboard</span>
    </button>
    <button class="nav-item" data-screen="settings" onclick="showScreen('settings')">
      <span class="icon nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></span>
      <span class="label" data-i18n="nav_settings">Ajustes</span>
    </button>
  </nav>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- DETAIL MODAL -->
<div class="modal-overlay" id="detailModal" onclick="closeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div id="modalBody"></div>
  </div>
</div>

<!-- CHART.JS CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>


<script>
// ===============================================
// GLOBAL ERROR HANDLER
// ===============================================
window.onerror = function(msg, url, line, col, error) {
  console.error('Error:', msg, 'Line:', line, error);
  const toast = document.getElementById('toast');
  if (toast) {
    toast.textContent = 'Error: ' + msg;
    toast.className = 'toast error show';
    setTimeout(() => toast.classList.remove('show'), 5000);
  }
  return true;
};

// ===============================================
// STATE
// ===============================================
let currentLang = 'es';
let expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
let currentImage = null;

// ===============================================
// i18n — Bilingual (ES/EN)
// ===============================================
const i18n = {
  es: {
    welcome_greeting: 'Buenos días',
    this_month: 'Este mes',
    pending_approval: 'Pendientes',
    new_expense: 'Nuevo Gasto',
    recent_expenses: 'Gastos recientes',
    no_expenses: 'No hay gastos registrados aún.\nPulsa "Nuevo Gasto" para empezar.',
    capture_title: 'Capturar ticket',
    capture_instruction: 'Sube o arrastra tu ticket',
    capture_formats: 'JPG, PNG o PDF · Máx 10MB',
    take_photo: 'Hacer foto',
    choose_file: 'Elegir archivo',
    ocr_processing: 'Analizando ticket...',
    ocr_extracting: 'Extrayendo datos automáticamente',
    expense_detail: 'Detalle del gasto',
    ocr_confidence: 'Fiabilidad OCR',
    basic_info: 'Información básica',
    provider: 'Proveedor',
    date: 'Fecha',
    category: 'Categoría',
    amounts: 'Importes',
    total_amount: 'Total (€)',
    vat: 'IVA (€)',
    vat_rate: 'Tipo IVA (%)',
    payment_method: 'Método pago',
    additional: 'Adicional',
    notes: 'Notas / Comentarios',
    save_draft: 'Borrador',
    submit: 'Enviar',
    auto: 'AUTO',
    location_tax: 'Localización y Fiscalidad',
    address: 'Dirección',
    city: 'Ciudad',
    tax_id: 'NIF / Tax ID',
    ocr_url: 'URL del Motor OCR (AI Builder)',
    ocr_url_help: 'Pega aquí la URL HTTP POST del flujo que lee los tickets',
    settings: 'Ajustes',
    your_name: 'Tu nombre',
    language: 'Idioma',
    notifications: 'Notificaciones',
    notif_desc: 'Push y email',
    policies: 'Políticas de gasto',
    cat_food: 'Comidas',
    cat_hotel: 'Hotel',
    cat_transport: 'Transporte',
    limit: 'Límite diario',
    limit_night: 'Límite por noche',
    limit_trip: 'Límite por viaje',
    data_export: 'Exportar datos',
    export_csv: 'Exportar a CSV (Excel)',
    nav_home: 'Inicio',
    nav_capture: 'Capturar',
    nav_settings: 'Ajustes',
    status_draft: 'Borrador',
    status_pending: 'Pendiente',
    status_approved: 'Aprobado',
    status_rejected: 'Rechazado',
    saved_draft: 'Gasto guardado como borrador',
    submitted: 'Gasto enviado para aprobación',
    exported: 'CSV descargado correctamente',
    policy_warn_food: 'Aviso: Comidas: el límite diario es de 50 €',
    policy_warn_hotel: 'Aviso: Hotel: el límite por noche es de 120 €',
    policy_warn_transport: 'Aviso: Transporte: el límite por viaje es de 80 €',
    delete_confirm: '¿Seguro que quieres eliminar este gasto?',
    deleted: 'Gasto eliminado',
    nav_dashboard: 'Dashboard',
    dash_month: 'Este mes',
    dash_quarter: 'Trimestre',
    dash_year: 'Año',
    dash_all: 'Todo',
    dash_total_spend: 'Gasto total',
    dash_approved: 'Aprobados',
    dash_pending: 'Pendientes',
    dash_policy_breaks: 'Incumplimientos',
    dash_avg_expense: 'Media por gasto',
    dash_count: 'Nº gastos',
    dash_monthly_trend: 'Evolución mensual',
    dash_by_category: 'Gasto por categoría',
    dash_top_providers: 'Top proveedores',
    dash_by_status: 'Por estado',
    dash_export_report: 'Informe PDF',
    dash_no_data: 'Añade gastos para ver el dashboard',
    dash_this_period: 'ESTE MES',
    dash_expenses: 'Gastos',
    dash_top_expenses: 'Top gastos',
    your_email: 'Tu email corporativo',
    cloud_sync: 'Sincronización en la nube',
    sync_not_configured: 'No configurado',
    sync_desc: 'Conecta Power Automate para sincronizar',
    sync_connected: 'Conectado',
    sync_desc_ok: 'Los gastos se sincronizan automáticamente',
    flow_url: 'URL del flujo de Power Automate',
    flow_url_help: 'Pega aquí la URL HTTP POST de tu flujo',
    test_sync: 'Probar conexión',
    sync_testing: 'Probando...',
    sync_success: 'Conexión exitosa con Power Automate',
    sync_error: 'Error de conexión. Verifica la URL del flujo',
    sync_sending: 'Enviando a la nube...',
    sync_sent: 'Gasto sincronizado correctamente',
    sync_offline: 'Sin conexión. Se guardó localmente y se enviará después',
    sync_need_config: 'Configura la URL del flujo en Ajustes',
    sync_need_name: 'Introduce tu nombre y email en Ajustes',
    generate_report: 'Generar informe mensual',
    report_month: 'Mes del informe',
  },
  en: {
    welcome_greeting: 'Good morning',
    this_month: 'This month',
    pending_approval: 'Pending',
    new_expense: 'New Expense',
    recent_expenses: 'Recent expenses',
    no_expenses: 'No expenses recorded yet.\nTap "New Expense" to start.',
    capture_title: 'Capture receipt',
    capture_instruction: 'Upload or drag your receipt',
    capture_formats: 'JPG, PNG or PDF · Max 10MB',
    take_photo: 'Take photo',
    choose_file: 'Choose file',
    ocr_processing: 'Analyzing receipt...',
    ocr_extracting: 'Extracting data automatically',
    expense_detail: 'Expense detail',
    ocr_confidence: 'OCR confidence',
    basic_info: 'Basic info',
    provider: 'Provider',
    date: 'Date',
    category: 'Category',
    amounts: 'Amounts',
    total_amount: 'Total (€)',
    vat: 'VAT (€)',
    vat_rate: 'VAT rate (%)',
    payment_method: 'Payment method',
    additional: 'Additional',
    notes: 'Notes / Comments',
    save_draft: 'Draft',
    submit: 'Submit',
    auto: 'AUTO',
    location_tax: 'Location & Tax Info',
    address: 'Address',
    city: 'City',
    tax_id: 'VAT / Tax ID',
    ocr_url: 'OCR Engine URL (AI Builder)',
    ocr_url_help: 'Paste the HTTP POST URL of your receipt flow here',
    settings: 'Settings',
    your_name: 'Your name',
    language: 'Language',
    notifications: 'Notifications',
    notif_desc: 'Push & email',
    policies: 'Expense policies',
    cat_food: 'Meals',
    cat_hotel: 'Hotel',
    cat_transport: 'Transport',
    limit: 'Daily limit',
    limit_night: 'Limit per night',
    limit_trip: 'Limit per trip',
    data_export: 'Export data',
    export_csv: 'Export to CSV (Excel)',
    nav_home: 'Home',
    nav_capture: 'Capture',
    nav_settings: 'Settings',
    status_draft: 'Draft',
    status_pending: 'Pending',
    status_approved: 'Approved',
    status_rejected: 'Rejected',
    saved_draft: 'Expense saved as draft',
    submitted: 'Expense submitted for approval',
    exported: 'CSV downloaded successfully',
    policy_warn_food: 'Aviso: Meals: daily limit is 50 €',
    policy_warn_hotel: 'Aviso: Hotel: limit per night is 120 €',
    policy_warn_transport: 'Aviso: Transport: limit per trip is 80 €',
    delete_confirm: 'Are you sure you want to delete this expense?',
    deleted: 'Expense deleted',
    nav_dashboard: 'Dashboard',
    dash_month: 'This month',
    dash_quarter: 'Quarter',
    dash_year: 'Year',
    dash_all: 'All',
    dash_total_spend: 'Total spend',
    dash_approved: 'Approved',
    dash_pending: 'Pending',
    dash_policy_breaks: 'Policy breaks',
    dash_avg_expense: 'Avg per expense',
    dash_count: 'Nº expenses',
    dash_monthly_trend: 'Monthly trend',
    dash_by_category: 'Spend by category',
    dash_top_providers: 'Top providers',
    dash_by_status: 'By status',
    dash_export_report: 'PDF Report',
    dash_no_data: 'Add expenses to see the dashboard',
    dash_this_period: 'THIS MONTH',
    dash_expenses: 'Expenses',
    dash_top_expenses: 'Top expenses',
    your_email: 'Your corporate email',
    cloud_sync: 'Cloud sync',
    sync_not_configured: 'Not configured',
    sync_desc: 'Connect Power Automate to sync',
    sync_connected: 'Connected',
    sync_desc_ok: 'Expenses sync automatically',
    flow_url: 'Power Automate flow URL',
    flow_url_help: 'Paste the HTTP POST URL from your flow here',
    test_sync: 'Test connection',
    sync_testing: 'Testing...',
    sync_success: 'Successfully connected to Power Automate',
    sync_error: 'Connection error. Check the flow URL',
    sync_sending: 'Sending to cloud...',
    sync_sent: 'Expense synced successfully',
    sync_offline: 'Offline. Saved locally, will sync later',
    sync_need_config: 'Configure the flow URL in Settings',
    sync_need_name: 'Enter your name and email in Settings',
    generate_report: 'Generate monthly report',
    report_month: 'Report month',
  }
};

function t(key) {
  return i18n[currentLang][key] || key;
}

function applyLang() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (i18n[currentLang][key]) {
      el.textContent = i18n[currentLang][key];
    }
  });
  document.getElementById('currentLang').textContent = currentLang === 'es' ? 'Español' : 'English';
  const toggle = document.getElementById('langToggle');
  if (currentLang === 'en') toggle.classList.add('active');
  else toggle.classList.remove('active');
}

function toggleLang() {
  currentLang = currentLang === 'es' ? 'en' : 'es';
  localStorage.setItem('lang', currentLang);
  applyLang();
  renderExpenses();
}

// ===============================================
// NAVIGATION
// ===============================================
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + name).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => {
    n.classList.toggle('active', n.dataset.screen === name);
  });
  if (name === 'capture') resetCapture();
  if (name === 'home') renderExpenses();
  if (name === 'dashboard') renderDashboard();
  window.scrollTo(0, 0);
}

function resetCapture() {
  document.getElementById('captureZone').classList.remove('hidden');
  document.querySelector('.capture-buttons').classList.remove('hidden');
  document.getElementById('ocrProcessing').classList.remove('active');
  document.getElementById('fileInput').value = '';
  document.getElementById('cameraInput').value = '';
  currentImage = null;
}

// ===============================================
// FILE HANDLING + DRAG & DROP
// ===============================================
const captureZone = document.getElementById('captureZone');

captureZone.addEventListener('dragover', (e) => {
  e.preventDefault();
  captureZone.classList.add('dragover');
});

captureZone.addEventListener('dragleave', () => {
  captureZone.classList.remove('dragover');
});

captureZone.addEventListener('drop', (e) => {
  e.preventDefault();
  captureZone.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) processFile(file);
});

function handleFileSelect(event) {
  const file = event.target.files[0];
  if (file) processFile(file);
}

function processFile(file) {
  if (file.size > 10 * 1024 * 1024) {
    showToast('Archivo demasiado grande (máx 10MB)', 'error');
    return;
  }

  const reader = new FileReader();
  reader.onload = (e) => {
    currentImage = e.target.result;
    startOCR(currentImage);
  };
  reader.readAsDataURL(file);
}

// ===============================================
// OCR ENGINE (Power Automate + AI Builder)
// ===============================================
async function startOCR(imageData) {
  // Mostrar UI de carga
  document.getElementById('captureZone').classList.add('hidden');
  document.querySelector('.capture-buttons').classList.add('hidden');
  const processing = document.getElementById('ocrProcessing');
  processing.classList.add('active');
  const progressBar = document.getElementById('ocrProgressBar');
  progressBar.style.width = '30%';

  const ocrUrl = document.getElementById('settingsOcrUrl').value.trim();

  // Si no hay URL configurada, abrimos el formulario vacío
  if (!ocrUrl) {
    showToast(currentLang === 'es' ? 'Falta la URL del Motor OCR en Ajustes' : 'OCR Engine URL missing in Settings', 'error');
    processing.classList.remove('active');
    fillForm({ confidence: 0 }); 
    showScreen('form');
    return;
  }

  try {
    // 1. Enviar la imagen a Power Automate
    progressBar.style.width = '60%';
    const response = await fetch(ocrUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image: imageData })
    });

    progressBar.style.width = '90%';

    if (!response.ok) throw new Error('Error en la conexión con AI Builder');

    // 2. Recibir los datos limpios
    const data = await response.json();
    progressBar.style.width = '100%';

    // 3. Limpieza de seguridad (por si AI Builder no separa la ciudad de la dirección)
    let finalCity = data.city || '';
    let finalAddress = data.address || '';

    if (finalAddress && !finalCity) {
      const cpMatch = finalAddress.match(/\b(\d{5})\b\s*([A-Za-zÁÉÍÓÚáéíóúÑñÄÖÜäöüß\s]+)/i);
      if (cpMatch) {
        finalCity = cpMatch[2].trim();
      }
    }

    // 4. Preparar el objeto para el formulario
    const parsed = {
      provider: data.provider || '',
      date: data.date || '',
      total: data.total || '',
      vat: data.tax || '',
      address: finalAddress,
      city: finalCity,
      taxId: data.taxId || '',
      category: detectCategory(data.provider || ''), // Intenta deducir la categoría
      confidence: 98 // Fiabilidad casi perfecta con IA
    };

    setTimeout(() => {
      processing.classList.remove('active');
      fillForm(parsed);
      showScreen('form');
    }, 400);

  } catch (err) {
    console.error('OCR Error:', err);
    processing.classList.remove('active');
    fillForm({ confidence: 0 });
    showToast(currentLang === 'es' ? 'Error al procesar con IA. Rellena a mano.' : 'AI processing error', 'error');
    showScreen('form');
  }
}

function cleanProviderName(name) {
  return name
    .replace(/[^\w\sáéíóúñüÁÉÍÓÚÑÜàèìòùâêîôûäëïöü&\-\.']/gi, '')
    .replace(/\b(S\.?L\.?|S\.?A\.?|S\.?L\.?U\.?)\b/gi, match => match.toUpperCase())
    .replace(/\s+/g, ' ')
    .trim()
    .substring(0, 80);
}

function detectCategory(text) {
  const t = text.toLowerCase();

  // Weighted scoring: each category has patterns with weights
  const categories = {
    comida: {
      patterns: [
        { regex: /restauran/i, weight: 3 },
        { regex: /cafeter[ií]a/i, weight: 3 },
        { regex: /bar\s|bar$/im, weight: 2 },
        { regex: /men[uú]|menu/i, weight: 3 },
        { regex: /comida|cena|almuerz|desayun/i, weight: 3 },
        { regex: /tapas|racion|plato/i, weight: 2 },
        { regex: /cervez|refres|agua\s*mineral|vino|copa/i, weight: 1.5 },
        { regex: /pizza|burger|kebab|bocadill|sandwich|ensalad/i, weight: 2 },
        { regex: /cubierto|mesa|camarero|propina|servicio\s*mesa/i, weight: 2 },
        { regex: /entrante|postre|primer|segundo|caf[eé]/i, weight: 1.5 },
        { regex: /marisquer|asador|taberna|mesón|mesonero|chiringuito|tasca/i, weight: 3 },
        { regex: /telepizza|mcdon|burger\s*king|kfc|five\s*guys|goiko|100\s*montaditos/i, weight: 3 },
        { regex: /just\s*eat|deliveroo|glovo|uber\s*eats/i, weight: 2 },
      ]
    },
    combustible: {
      patterns: [
        { regex: /gasolina|gas[oó]leo|diesel|gasoil/i, weight: 3 },
        { regex: /estaci[oó]n.{0,3}servicio/i, weight: 3 },
        { regex: /combustible|fuel|carburante/i, weight: 3 },
        { regex: /repsol|cepsa|bp\b|shell|galp|petronor|bonarea/i, weight: 3 },
        { regex: /litros?\s*[xX@]\s*\d/i, weight: 3 },
        { regex: /surtidor|repostaje|gasolinera/i, weight: 3 },
        { regex: /e\.?s\.\s/i, weight: 1 },
      ]
    },
    hotel: {
      patterns: [
        { regex: /hotel/i, weight: 3 },
        { regex: /hostal|pens[ií][oó]n|albergue/i, weight: 3 },
        { regex: /alojamiento|hospedaje/i, weight: 3 },
        { regex: /habitaci[oó]n|room/i, weight: 2 },
        { regex: /check.?in|check.?out/i, weight: 2 },
        { regex: /pernoctaci[oó]n|noche|night/i, weight: 2 },
        { regex: /booking|reservation|reserva/i, weight: 1 },
        { regex: /NH\s|MELI[AÁ]|PARADORES|AC\sHOTEL|IBIS|NOVOTEL|HILTON|MARRIOTT/i, weight: 3 },
        { regex: /airbnb|apartamento\s*tur/i, weight: 2 },
      ]
    },
    parking: {
      patterns: [
        { regex: /parking/i, weight: 3 },
        { regex: /aparcamiento|estacionamiento/i, weight: 3 },
        { regex: /garaje|garage/i, weight: 2 },
        { regex: /empark|saba\b|interparking|aena\s*park/i, weight: 3 },
        { regex: /entrada.{0,10}salida/i, weight: 2 },
        { regex: /barrera|plaza.{0,5}\d/i, weight: 1 },
        { regex: /hora.{0,5}entrada|hora.{0,5}salida/i, weight: 2 },
      ]
    },
    peaje: {
      patterns: [
        { regex: /peaje/i, weight: 3 },
        { regex: /toll/i, weight: 3 },
        { regex: /autopista/i, weight: 2 },
        { regex: /v[ií]a.?t\b|telepeaje/i, weight: 3 },
        { regex: /abertis|cintra|itinere|globalvia|audasa|acesa|aucalsa/i, weight: 3 },
        { regex: /AP-\d|AP\d/i, weight: 2 },
      ]
    },
    transporte: {
      patterns: [
        { regex: /taxi\b/i, weight: 3 },
        { regex: /uber(?!\s*eat)/i, weight: 3 },
        { regex: /cabify|bolt|freenow|mytaxi/i, weight: 3 },
        { regex: /renfe|cercan[ií]as|ave\b|tren|train/i, weight: 3 },
        { regex: /avi[oó]n|vuelo|flight|boarding/i, weight: 3 },
        { regex: /iberia|vueling|ryanair|easyjet|air\s*europa|lufthansa/i, weight: 3 },
        { regex: /autob[uú]s|bus\b|autocar/i, weight: 2 },
        { regex: /metro\b|tranv[ií]a|cercan[ií]a/i, weight: 2 },
        { regex: /billete|ticket\s*transp/i, weight: 2 },
        { regex: /alsa|avanza|socibus|iryo|ouigo/i, weight: 3 },
        { regex: /tarifa.{0,10}(carrera|viaje|trayecto)/i, weight: 2 },
      ]
    },
  };

  let bestCategory = '';
  let bestScore = 0;

  for (const [cat, data] of Object.entries(categories)) {
    let score = 0;
    for (const p of data.patterns) {
      if (p.regex.test(t)) score += p.weight;
    }
    if (score > bestScore) {
      bestScore = score;
      bestCategory = cat;
    }
  }

  return bestScore >= 1.5 ? bestCategory : '';
}

// ===============================================
// FILL FORM
// ===============================================
function fillForm(parsed) {
  const preview = document.getElementById('ticketPreview');
  if (currentImage) {
    preview.src = currentImage;
    preview.classList.remove('hidden');
  } else {
    preview.classList.add('hidden');
  }

  // Confidence
  const conf = Math.round(parsed.confidence || 0);
  const confFill = document.getElementById('confidenceFill');
  const confValue = document.getElementById('confidenceValue');
  confValue.textContent = conf + '%';
  confFill.style.width = conf + '%';
  confFill.className = 'confidence-fill ' + (conf >= 70 ? 'high' : conf >= 40 ? 'medium' : 'low');

  // Fill fields with auto-fill styling
  setField('inputProvider', parsed.provider, 'badge-provider');
  setField('inputDate', parsed.date, 'badge-date');
  setField('inputTotal', parsed.total, 'badge-total');
  setField('inputVAT', parsed.vat, 'badge-vat');
  setField('inputAddress', parsed.address, 'badge-address');
  setField('inputCity', parsed.city, 'badge-city');
  setField('inputTaxId', parsed.taxId, 'badge-taxId');

  if (parsed.category) {
    document.getElementById('inputCategory').value = parsed.category;
    document.getElementById('inputCategory').classList.add('auto-filled');
    showBadge('badge-category');
  }

  if (parsed.vatRate) {
    document.getElementById('inputVATRate').value = parsed.vatRate;
  }

  // If no date detected, default to today
  if (!parsed.date) {
    document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];
  }

  // Policy checks
  checkPolicies();
}

function setField(id, value, badgeId) {
  const el = document.getElementById(id);
  if (value) {
    el.value = value;
    el.classList.add('auto-filled');
    if (badgeId) showBadge(badgeId);
  } else {
    el.value = '';
    el.classList.remove('auto-filled');
    if (badgeId) hideBadge(badgeId);
  }
}

function showBadge(id) {
  const el = document.getElementById(id);
  if (el) el.style.display = 'inline';
}

function hideBadge(id) {
  const el = document.getElementById(id);
  if (el) el.style.display = 'none';
}

// ===============================================
// POLICY ENGINE
// ===============================================
const POLICIES = {
  comida: { limit: 50, key: 'policy_warn_food' },
  hotel: { limit: 120, key: 'policy_warn_hotel' },
  transporte: { limit: 80, key: 'policy_warn_transport' },
};

function checkPolicies() {
  const alerts = document.getElementById('policyAlerts');
  alerts.innerHTML = '';

  const category = document.getElementById('inputCategory').value;
  const total = parseFloat(document.getElementById('inputTotal').value) || 0;

  if (category && POLICIES[category] && total > POLICIES[category].limit) {
    alerts.innerHTML = `
      <div class="policy-alert warning">
        <span class="icon"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/></svg></span>
        <span>${t(POLICIES[category].key)}</span>
      </div>
    `;
  }

  // Duplicate check
  const date = document.getElementById('inputDate').value;
  const provider = document.getElementById('inputProvider').value.toLowerCase();
  const isDuplicate = expenses.some(e =>
    e.date === date &&
    e.provider.toLowerCase() === provider &&
    Math.abs(e.total - total) < 0.01
  );

  if (isDuplicate && provider) {
    alerts.innerHTML += `
      <div class="policy-alert error">
        <span class="icon"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg></span>
        <span>${currentLang === 'es' ? 'Posible duplicado: ya existe un gasto similar' : 'Possible duplicate: a similar expense exists'}</span>
      </div>
    `;
  }
}

// Re-check on input changes
document.getElementById('inputTotal').addEventListener('input', checkPolicies);
document.getElementById('inputCategory').addEventListener('change', checkPolicies);

// ===============================================
// SAVE / SUBMIT + CLOUD SYNC
// ===============================================
function getFormData(status) {
  return {
    id: Date.now().toString(36) + Math.random().toString(36).substr(2, 4),
    provider: document.getElementById('inputProvider').value,
    date: document.getElementById('inputDate').value,
    category: document.getElementById('inputCategory').value,
    total: parseFloat(document.getElementById('inputTotal').value) || 0,
    vat: parseFloat(document.getElementById('inputVAT').value) || 0,
    vatRate: document.getElementById('inputVATRate').value,
    payment: document.getElementById('inputPayment').value,
    notes: document.getElementById('inputNotes').value,
    address: document.getElementById('inputAddress').value,
    city: document.getElementById('inputCity').value,
    taxId: document.getElementById('inputTaxId').value,
    status: status,
    image: currentImage || null,
    createdAt: new Date().toISOString(),
    synced: false,
    userName: localStorage.getItem('userName') || '',
    userEmail: localStorage.getItem('userEmail') || '',
  };
}

// Compress image to thumbnail to avoid localStorage overflow
function compressImage(dataUrl) {
  if (!dataUrl || !dataUrl.startsWith('data:')) return dataUrl;
  try {
    const canvas = document.createElement('canvas');
    const img = new Image();
    img.src = dataUrl;
    // If image is loaded synchronously (from cache), compress it
    if (img.naturalWidth > 0) {
      const maxW = 600;
      const scale = Math.min(1, maxW / img.naturalWidth);
      canvas.width = img.naturalWidth * scale;
      canvas.height = img.naturalHeight * scale;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      return canvas.toDataURL('image/jpeg', 0.6);
    }
    // If not loaded yet, return original (will be large but works)
    return dataUrl;
  } catch (e) {
    return dataUrl;
  }
}

function validateForm(requireAll) {
  const provider = document.getElementById('inputProvider').value.trim();
  const total = document.getElementById('inputTotal').value;

  if (requireAll) {
    if (!provider) {
      showToast(currentLang === 'es' ? 'Introduce el proveedor' : 'Enter the provider', 'warning');
      document.getElementById('inputProvider').focus();
      return false;
    }
    if (!total || parseFloat(total) <= 0) {
      showToast(currentLang === 'es' ? 'Introduce el importe total' : 'Enter the total amount', 'warning');
      document.getElementById('inputTotal').focus();
      return false;
    }
  }
  return true;
}

function saveDraft() {
  try {
    const data = getFormData('draft');
    expenses.unshift(data);
    saveExpenses();
    showToast(t('saved_draft'), 'success');
    showScreen('home');
  } catch (err) {
    console.error('Save draft error:', err);
    showToast(currentLang === 'es' ? 'Error al guardar.' : 'Save error.', 'error');
  }
}

function submitExpense(e) {
  if (e) e.preventDefault();
  if (!validateForm(true)) return;
  try {
    const data = getFormData('pending');
    expenses.unshift(data);
    saveExpenses();
    showScreen('home');
    // Attempt cloud sync
    const flowUrl = getFlowUrl();
    if (flowUrl) {
      showToast(currentLang === 'es' ? 'Enviando...' : 'Sending...', 'success');
      syncToCloud(data).then(ok => {
        if (!ok) {
          showToast(t('sync_offline'), 'warning');
        }
      });
    } else {
      showToast(t('submitted'), 'success');
    }
  } catch (err) {
    console.error('Submit error:', err);
    showToast(currentLang === 'es' ? 'Error al enviar.' : 'Submit error.', 'error');
  }
}

function saveExpenses() {
  try {
    localStorage.setItem('expenses', JSON.stringify(expenses));
  } catch (e) {
    console.warn('localStorage full, compressing...');
    for (let i = expenses.length - 1; i >= 0; i--) {
      if (expenses[i].image && expenses[i].image !== 'image_captured') {
        expenses[i].image = 'image_captured';
        try { localStorage.setItem('expenses', JSON.stringify(expenses)); return; }
        catch (e2) { continue; }
      }
    }
    showToast(currentLang === 'es' ? 'Memoria llena. Exporta gastos.' : 'Storage full. Export expenses.', 'warning');
  }
}

// ===============================================
// CLOUD SYNC (Power Automate)
// ===============================================
function getFlowUrl() {
  return localStorage.getItem('flowUrl') || '';
}

function saveEmail() {
  const email = document.getElementById('settingsEmail').value;
  localStorage.setItem('userEmail', email);
}

function saveFlowUrl() {
  const url = document.getElementById('settingsFlowUrl').value.trim();
  localStorage.setItem('flowUrl', url);
  updateSyncStatus();
}

function saveOcrUrl() {
  const url = document.getElementById('settingsOcrUrl').value.trim();
  localStorage.setItem('ocrUrl', url);
}

function updateSyncStatus() {
  const url = getFlowUrl();
  const badge = document.getElementById('syncBadge');
  const label = document.getElementById('syncStatusLabel');
  const desc = document.getElementById('syncStatusDesc');

  if (url) {
    badge.textContent = 'ON';
    badge.className = 'sync-badge online';
    if (label) label.textContent = t('sync_connected');
    if (desc) desc.textContent = t('sync_desc_ok');
  } else {
    badge.textContent = 'OFF';
    badge.className = 'sync-badge offline';
    if (label) label.textContent = t('sync_not_configured');
    if (desc) desc.textContent = t('sync_desc');
  }
}

async function syncToCloud(expenseData) {
  const flowUrl = getFlowUrl();
  if (!flowUrl) return; // No sync configured, that's OK

  const name = localStorage.getItem('userName');
  const email = localStorage.getItem('userEmail');
  if (!name || !email) {
    showToast(t('sync_need_name'), 'warning');
    return;
  }

  try {
 const payload = {
      action: 'add_expense',
      userName: name,
      userEmail: email,
      expense: {
        id: expenseData.id,
        provider: expenseData.provider || '',
        date: expenseData.date || '',
        category: expenseData.category || '',
        total: expenseData.total || 0,
        vat: expenseData.vat || 0,
        vatRate: expenseData.vatRate || '',
        payment: expenseData.payment || '',
        notes: expenseData.notes || '',
        status: expenseData.status || 'pending',
        createdAt: expenseData.createdAt || new Date().toISOString(),
      },
      // -- LOS 3 NUEVOS CAMPOS QUE VIAJAN A POWER AUTOMATE --
      address: expenseData.address || '',
      city: expenseData.city || '',
      taxId: expenseData.taxId || '',
      
      // Send image only if it's a real base64 image
      image: (expenseData.image && expenseData.image.startsWith('data:')) ? expenseData.image : null,
    };

    const resp = await fetch(flowUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      mode: 'cors',
      body: JSON.stringify(payload),
    });

    if (resp.ok || resp.status === 202) {
      // 200 or 202 (Accepted) both mean success for Power Automate
      const idx = expenses.findIndex(e => e.id === expenseData.id);
      if (idx >= 0) { expenses[idx].synced = true; saveExpenses(); }
      showToast(t('sync_sent'), 'success');
      return true;
    } else {
      // Power Automate may return error codes (400, 500) when internal scopes fail
      // but the data might still have been saved. Check response body.
      let respBody = '';
      try { respBody = await resp.text(); } catch(e) {}
      console.warn('Sync response:', resp.status, respBody);
      
      // If we got ANY response from Power Automate (not a network error), 
      // the flow ran — data was likely saved even if scopes had errors
      if (resp.status >= 400 && resp.status < 500) {
        // 4xx = flow ran but had issues. Data probably saved.
        const idx = expenses.findIndex(e => e.id === expenseData.id);
        if (idx >= 0) { expenses[idx].synced = true; saveExpenses(); }
        showToast(currentLang === 'es' ? 'Gasto guardado (con advertencias)' : 'Expense saved (with warnings)', 'warning');
        return true;
      }
      return false;
    }
  } catch (err) {
    console.warn('Sync error:', err.message);
    return false;
  }
}

async function testCloudSync() {
  const flowUrl = getFlowUrl();
  if (!flowUrl) {
    showToast(t('sync_need_config'), 'warning');
    return;
  }

  const btn = document.getElementById('btnTestSync');
  btn.disabled = true;
  btn.innerHTML = '<span>' + t('sync_testing') + '</span>';

  try {
    const resp = await fetch(flowUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'test',
        userName: localStorage.getItem('userName') || 'Test User',
        userEmail: localStorage.getItem('userEmail') || 'test@test.com',
        timestamp: new Date().toISOString(),
      }),
    });

    if (resp.ok) {
      showToast(t('sync_success'), 'success');
      updateSyncStatus();
    } else {
      showToast(t('sync_error') + ' (' + resp.status + ')', 'error');
    }
  } catch (err) {
    showToast(t('sync_error'), 'error');
  }

  btn.disabled = false;
  btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg> <span>' + t('test_sync') + '</span>';
}

// Retry sync for unsynced expenses (silent, no toasts)
async function retrySyncAll() {
  const flowUrl = getFlowUrl();
  if (!flowUrl) return;

  // Only retry real user-submitted expenses, not demo data
  const unsynced = expenses.filter(e => !e.synced && e.status === 'pending' && e.userEmail);
  if (unsynced.length === 0) return;

  console.log('Retrying sync for', unsynced.length, 'expenses...');
  for (const exp of unsynced) {
    const ok = await syncToCloud(exp);
    if (!ok) break; // Stop retrying if one fails (probably offline)
    await new Promise(r => setTimeout(r, 1000)); // Rate limit
  }
}

function deleteExpense(id) {
  if (!confirm(t('delete_confirm'))) return;
  expenses = expenses.filter(e => e.id !== id);
  saveExpenses();
  closeModal();
  renderExpenses();
  showToast(t('deleted'), 'success');
}

// ===============================================
// RENDER EXPENSES
// ===============================================
const CATEGORY_ICONS = {
  comida: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>',
  transporte: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>',
  hotel: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21V7a2 2 0 0 1 2-2h6"/><path d="M13 21V3a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v18"/><path d="M7 10h0M7 14h0M17 7h0M17 11h0M17 15h0"/></svg>',
  combustible: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 22V5a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v17"/><path d="M15 10h2a2 2 0 0 1 2 2v1a2 2 0 0 0 2 2 2 2 0 0 0 0-4V7l-2-2"/><path d="M3 22h12"/><path d="M7 8h4"/></svg>',
  parking: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 17V7h4a3 3 0 0 1 0 6H9"/></svg>',
  peaje: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19h16M4 15l4-8h8l4 8"/><circle cx="12" cy="19" r="2"/></svg>',
};

const CATEGORY_ICON_DEFAULT = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>';

const STATUS_MAP = {
  draft: 'status-draft',
  pending: 'status-pending',
  approved: 'status-approved',
  rejected: 'status-rejected',
};

function renderExpenses() {
  const list = document.getElementById('expenseList');
  
  // Recreamos siempre el estado vacío de forma segura para que nunca dé error 'null'
  const emptyHTML = `
    <div class="empty-state" id="emptyState" style="display: none;">
      <div class="icon" style="opacity:0.3"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg></div>
      <p data-i18n="no_expenses">${t('no_expenses').replace('\n', '<br>')}</p>
    </div>
  `;

  if (expenses.length === 0) {
    list.innerHTML = emptyHTML;
    document.getElementById('emptyState').style.display = 'block';
  } else {
    list.innerHTML = emptyHTML + expenses.slice(0, 20).map(exp => `
      <div class="expense-item" onclick="showDetail('${exp.id}')">
        <div class="expense-icon ${exp.category}">
          ${CATEGORY_ICONS[exp.category] || CATEGORY_ICON_DEFAULT}
        </div>
        <div class="expense-info">
          <div class="expense-provider">${exp.provider || (currentLang === 'es' ? 'Sin proveedor' : 'No provider')}</div>
          <div class="expense-meta">${formatDate(exp.date)} · ${exp.category || '—'}</div>
        </div>
        <div>
          <div class="expense-amount">${formatMoney(exp.total)}</div>
          <div class="expense-status ${STATUS_MAP[exp.status]}">${t('status_' + exp.status)}</div>
        </div>
      </div>
    `).join('');
  }

  // Update stats
  const now = new Date();
  const monthExpenses = expenses.filter(e => {
    const d = new Date(e.date);
    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
  });
  const totalMonth = monthExpenses.reduce((sum, e) => sum + e.total, 0);
  const pendingCount = expenses.filter(e => e.status === 'pending').length;

  document.getElementById('totalMonth').textContent = formatMoney(totalMonth);
  document.getElementById('pendingCount').textContent = pendingCount;

  // Username
  const name = localStorage.getItem('userName') || (currentLang === 'es' ? 'Usuario' : 'User');
  document.getElementById('userName').textContent = name;
  document.getElementById('settingsName').value = localStorage.getItem('userName') || '';
}

function formatMoney(amount) {
  return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(amount);
}

function formatDate(dateStr) {
  if (!dateStr) return '—';
  const d = new Date(dateStr + 'T00:00:00');
  return d.toLocaleDateString(currentLang === 'es' ? 'es-ES' : 'en-GB', { day: 'numeric', month: 'short' });
}

// ===============================================
// DETAIL MODAL
// ===============================================
function showDetail(id) {
  const exp = expenses.find(e => e.id === id);
  if (!exp) return;

  const modal = document.getElementById('detailModal');
  const body = document.getElementById('modalBody');

  body.innerHTML = `
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
      <div class="expense-icon ${exp.category}" style="width:48px;height:48px;font-size:24px;">
        ${CATEGORY_ICONS[exp.category] || CATEGORY_ICON_DEFAULT}
      </div>
      <div>
        <div style="font-size:18px;font-weight:700;">${exp.provider || '—'}</div>
        <div style="color:var(--text-muted);font-size:13px;">${formatDate(exp.date)} · ${exp.category || '—'}</div>
      </div>
    </div>

    ${exp.image ? `<img src="${exp.image}" style="width:100%;max-height:180px;object-fit:contain;border-radius:10px;margin-bottom:16px;background:var(--bg-primary);border:1px solid var(--border);">` : ''}

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;">
      <div class="stat-box">
        <div class="stat-label">${t('total_amount')}</div>
        <div class="stat-value">${formatMoney(exp.total)}</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">${t('vat')}</div>
        <div class="stat-value" style="font-size:16px;">${formatMoney(exp.vat)}${exp.vatRate ? ' (' + exp.vatRate + '%)' : ''}</div>
      </div>
    </div>

    ${(exp.address || exp.taxId) ? `
    <div style="background: var(--bg-elevated); padding: 12px; border-radius: 10px; margin-bottom: 20px; font-size: 13px;">
      <div style="color: var(--text-muted); font-size: 11px; text-transform: uppercase; margin-bottom: 6px; font-weight: 700;">Datos Fiscales</div>
      ${exp.taxId ? `<div><strong>NIF/Tax ID:</strong> ${exp.taxId}</div>` : ''}
      ${exp.address ? `<div><strong>Dirección:</strong> ${exp.address}</div>` : ''}
      ${exp.city ? `<div><strong>Ciudad:</strong> ${exp.city}</div>` : ''}
    </div>
    ` : ''}
    
    <div style="margin-bottom:16px;">
      <div style="font-size:12px;color:var(--text-muted);margin-bottom:4px;">${t('payment_method')}</div>
      <div style="font-size:14px;">${exp.payment === 'tarjeta_corp' ? 'Tarjeta corp.' : exp.payment === 'efectivo' ? 'Efectivo' : 'Tarjeta propia'}</div>
    </div>

    ${exp.notes ? `
    <div style="margin-bottom:16px;">
      <div style="font-size:12px;color:var(--text-muted);margin-bottom:4px;">${t('notes')}</div>
      <div style="font-size:14px;">${exp.notes}</div>
    </div>
    ` : ''}

    <div style="margin-bottom:20px;">
      <span class="expense-status ${STATUS_MAP[exp.status]}" style="font-size:12px;padding:5px 12px;">${t('status_' + exp.status)}</span>
    </div>

    <div class="form-actions">
      <button class="btn btn-danger" onclick="deleteExpense('${exp.id}')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> ${currentLang === 'es' ? 'Eliminar' : 'Delete'}
      </button>
      <button class="btn btn-secondary" onclick="closeModal()">
        ${currentLang === 'es' ? 'Cerrar' : 'Close'}
      </button>
    </div>
  `;

  modal.classList.add('show');
}

function closeModal(e) {
  if (e && e.target !== e.currentTarget) return;
  document.getElementById('detailModal').classList.remove('show');
}

// ===============================================
// EXPORT CSV
// ===============================================
function exportToCSV() {
  if (expenses.length === 0) {
    showToast(currentLang === 'es' ? 'No hay datos para exportar' : 'No data to export', 'warning');
    return;
  }

  // Nuevas cabeceras añadidas
  const headers = ['ID', 'Proveedor', 'Fecha', 'Categoría', 'Total (€)', 'IVA (€)', 'Tipo IVA (%)', 'Dirección', 'Ciudad', 'NIF/TaxID', 'Método pago', 'Estado', 'Notas', 'Creado'];
  
  const rows = expenses.map(e => [
    e.id,
    `"${e.provider || ''}"`,
    e.date || '',
    e.category || '',
    e.total || 0,
    e.vat || 0,
    e.vatRate || '',
    `"${e.address || ''}"`,  // Nuevo
    `"${e.city || ''}"`,     // Nuevo
    `"${e.taxId || ''}"`,    // Nuevo
    e.payment || '',
    e.status || '',
    `"${(e.notes || '').replace(/"/g, '""')}"`,
    e.createdAt || '',
  ]);

  const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
  const bom = '\uFEFF';
  const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `gastos_schaeffler_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  showToast(t('exported'), 'success');
}

// ===============================================
// TOAST
// ===============================================
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = 'toast ' + type + ' show';
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// ===============================================
// SETTINGS
// ===============================================
function saveName() {
  const name = document.getElementById('settingsName').value;
  localStorage.setItem('userName', name);
  document.getElementById('userName').textContent = name || 'Usuario';
}

// ===============================================
// GREETING
// ===============================================
function updateGreeting() {
  const hour = new Date().getHours();
  const greetings = {
    es: hour < 12 ? 'Buenos días' : hour < 20 ? 'Buenas tardes' : 'Buenas noches',
    en: hour < 12 ? 'Good morning' : hour < 18 ? 'Good afternoon' : 'Good evening',
  };
  document.querySelector('[data-i18n="welcome_greeting"]').textContent = greetings[currentLang];
}

// ===============================================
// DASHBOARD (compact one-glance)
// ===============================================
let dashPeriod = 'month';
let chartMonthlyInst = null;
let chartCategoryInst = null;

const CATEGORY_COLORS = {
  comida: '#fb923c',
  transporte: '#60a5fa',
  hotel: '#a78bfa',
  combustible: '#34d399',
  parking: '#fbbf24',
  peaje: '#f87171',
  '': '#97a0af',
};

const CATEGORY_NAMES = {
  es: { comida: 'Comidas', transporte: 'Transporte', hotel: 'Hotel', combustible: 'Combustible', parking: 'Parking', peaje: 'Peaje', '': 'Otros' },
  en: { comida: 'Meals', transporte: 'Transport', hotel: 'Hotel', combustible: 'Fuel', parking: 'Parking', peaje: 'Toll', '': 'Other' },
};

const PERIOD_LABELS = {
  es: { month: 'ESTE MES', quarter: 'ESTE TRIMESTRE', year: 'ESTE AÑO', all: 'TOTAL' },
  en: { month: 'THIS MONTH', quarter: 'THIS QUARTER', year: 'THIS YEAR', all: 'ALL TIME' },
};

function setDashPeriod(period) {
  dashPeriod = period;
  document.querySelectorAll('.dash-pill').forEach(b => {
    b.classList.toggle('active', b.dataset.period === period);
  });
  renderDashboard();
}

function getFilteredExpenses() {
  const now = new Date();
  return expenses.filter(e => {
    if (dashPeriod === 'all') return true;
    const d = new Date(e.date);
    if (dashPeriod === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
    if (dashPeriod === 'quarter') {
      const q = Math.floor(now.getMonth() / 3);
      const eq = Math.floor(d.getMonth() / 3);
      return eq === q && d.getFullYear() === now.getFullYear();
    }
    if (dashPeriod === 'year') return d.getFullYear() === now.getFullYear();
    return true;
  });
}

function renderDashboard() {
  const filtered = getFilteredExpenses();

  // Period label
  const lbl = (PERIOD_LABELS[currentLang] || PERIOD_LABELS.es)[dashPeriod];
  const headerLabel = document.querySelector('.dash-header-label');
  if (headerLabel) headerLabel.textContent = lbl;

  // KPIs
  const totalSpend = filtered.reduce((s, e) => s + e.total, 0);
  const approved = filtered.filter(e => e.status === 'approved').length;
  const pending = filtered.filter(e => e.status === 'pending').length;
  const policyBreaks = filtered.filter(e => {
    const pol = POLICIES[e.category];
    return pol && e.total > pol.limit;
  }).length;
  const avg = filtered.length > 0 ? totalSpend / filtered.length : 0;

  document.getElementById('dashTotalSpend').textContent = formatMoney(totalSpend);
  document.getElementById('dashApproved').textContent = approved;
  document.getElementById('dashPending').textContent = pending;
  document.getElementById('dashPolicyBreaks').textContent = policyBreaks;
  document.getElementById('dashAvg').textContent = formatMoney(avg);
  document.getElementById('dashCount').textContent = filtered.length;

  renderCategoryChart(filtered);
  renderTopExpenses(filtered);
  renderMonthlyChart(filtered);
}

function renderCategoryChart(data) {
  const canvas = document.getElementById('chartCategory');
  if (!canvas) return;

  const catTotals = {};
  data.forEach(e => {
    const cat = e.category || '';
    catTotals[cat] = (catTotals[cat] || 0) + e.total;
  });

  const cats = Object.keys(catTotals).sort((a, b) => catTotals[b] - catTotals[a]);
  const values = cats.map(c => catTotals[c]);
  const colors = cats.map(c => CATEGORY_COLORS[c] || '#97a0af');
  const names = cats.map(c => (CATEGORY_NAMES[currentLang] || CATEGORY_NAMES.es)[c] || 'Otros');
  const total = values.reduce((s, v) => s + v, 0) || 1;

  if (chartCategoryInst) chartCategoryInst.destroy();

  chartCategoryInst = new Chart(canvas, {
    type: 'doughnut',
    data: {
      labels: names.length ? names : ['—'],
      datasets: [{
        data: values.length ? values : [1],
        backgroundColor: colors.length ? colors : ['#dfe1e6'],
        borderWidth: 0,
      }]
    },
    options: {
      responsive: false,
      cutout: '65%',
      plugins: { legend: { display: false }, tooltip: {
        callbacks: { label: (ctx) => ' ' + formatMoney(ctx.raw) + ' (' + Math.round(ctx.raw / total * 100) + '%)' }
      }},
    }
  });

  // Legend
  const legend = document.getElementById('categoryLegend');
  legend.innerHTML = cats.map((c, i) => `
    <div class="dash-legend-item">
      <div class="dash-legend-dot" style="background:${colors[i]}"></div>
      <span class="dash-legend-label">${names[i]}</span>
      <span class="dash-legend-pct">${Math.round(values[i] / total * 100)}%</span>
      <span class="dash-legend-value">${formatMoney(values[i])}</span>
    </div>
  `).join('') || `<span style="color:var(--text-muted);font-size:12px;">${t('dash_no_data')}</span>`;
}

function renderTopExpenses(data) {
  const container = document.getElementById('topProviders');

  // Show the top 4 individual expenses (not grouped by provider) — like the reference image
  const sorted = [...data].sort((a, b) => b.total - a.total).slice(0, 4);

  container.innerHTML = sorted.map(e => `
    <div class="dash-top-item" onclick="showDetail('${e.id}')">
      <div class="dash-top-icon expense-icon ${e.category}">
        ${CATEGORY_ICONS[e.category] || CATEGORY_ICON_DEFAULT}
      </div>
      <div class="dash-top-info">
        <div class="dash-top-name">${e.provider || '—'}</div>
        <div class="dash-top-meta">${formatDate(e.date)} · ${(CATEGORY_NAMES[currentLang] || CATEGORY_NAMES.es)[e.category] || '—'}</div>
      </div>
      <div class="dash-top-amount">${formatMoney(e.total)}</div>
    </div>
  `).join('') || `<div style="text-align:center;padding:16px;color:var(--text-muted);font-size:13px;">${t('dash_no_data')}</div>`;
}

function renderMonthlyChart(data) {
  const canvas = document.getElementById('chartMonthly');
  if (!canvas) return;

  // Group by month
  const months = {};
  data.forEach(e => {
    const d = new Date(e.date);
    const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
    months[key] = (months[key] || 0) + e.total;
  });

  const sortedKeys = Object.keys(months).sort().slice(-6);
  const labels = sortedKeys.map(k => {
    const [y, m] = k.split('-');
    const d = new Date(parseInt(y), parseInt(m) - 1);
    return d.toLocaleDateString(currentLang === 'es' ? 'es-ES' : 'en-GB', { month: 'short' });
  });
  const values = sortedKeys.map(k => months[k]);

  if (chartMonthlyInst) chartMonthlyInst.destroy();

  chartMonthlyInst = new Chart(canvas, {
    type: 'line',
    data: {
      labels: labels.length ? labels : ['—'],
      datasets: [{
        data: values.length ? values : [0],
        borderColor: '#0052cc',
        backgroundColor: 'rgba(0, 82, 204, 0.08)',
        borderWidth: 2,
        fill: true,
        tension: 0.4,
        pointRadius: 3,
        pointBackgroundColor: '#0052cc',
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: {
        callbacks: { label: (ctx) => formatMoney(ctx.raw) }
      }},
      scales: {
        x: { grid: { display: false }, ticks: { color: '#97a0af', font: { size: 10 } } },
        y: { display: false },
      }
    }
  });
}

function exportDashPDF() {
  try {
    const filtered = getFilteredExpenses();
    const totalSpend = filtered.reduce((s, e) => s + e.total, 0);
    const byCategory = {};
    filtered.forEach(e => {
      const cat = e.category || 'otros';
      byCategory[cat] = (byCategory[cat] || 0) + e.total;
    });

    const catRows = Object.entries(byCategory)
      .sort((a, b) => b[1] - a[1])
      .map(([cat, amount]) => '<tr><td>' + ((CATEGORY_NAMES[currentLang] || CATEGORY_NAMES.es)[cat] || cat) + '</td><td style="text-align:right;font-weight:bold;">' + formatMoney(amount) + '</td></tr>')
      .join('');

    const expRows = filtered
      .sort((a, b) => new Date(b.date) - new Date(a.date))
      .slice(0, 50)
      .map(e => '<tr><td>' + e.date + '</td><td>' + e.provider + '</td><td>' + ((CATEGORY_NAMES[currentLang] || CATEGORY_NAMES.es)[e.category] || e.category || '—') + '</td><td style="text-align:right;">' + formatMoney(e.total) + '</td><td>' + t('status_' + e.status) + '</td></tr>')
      .join('');

    const title = currentLang === 'es' ? 'Informe de Gastos' : 'Expense Report';
    const genLabel = currentLang === 'es' ? 'Generado el' : 'Generated on';
    const dateStr = new Date().toLocaleDateString(currentLang === 'es' ? 'es-ES' : 'en-GB', { dateStyle: 'long' });
    const detailTitle = currentLang === 'es' ? 'Detalle de gastos' : 'Expense detail';
    const footerText = currentLang === 'es' ? 'Informe autogenerado' : 'Auto-generated report';

    const htmlContent = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>ExpenseFlow Report</title><style>body{font-family:Arial,sans-serif;max-width:800px;margin:40px auto;color:#001845;padding:0 20px;}h1{color:#172b4d;border-bottom:3px solid #0466c8;padding-bottom:8px;}h2{color:#33415c;margin-top:30px;}table{width:100%;border-collapse:collapse;margin:12px 0;}th,td{padding:8px 12px;border-bottom:1px solid #e2e8f0;text-align:left;font-size:13px;}th{background:#f8fafc;font-weight:600;color:#64748b;text-transform:uppercase;font-size:11px;}.kpi-row{display:flex;gap:16px;margin:16px 0;}.kpi{flex:1;background:#f8fafc;border-radius:8px;padding:16px;text-align:center;}.kpi-value{font-size:24px;font-weight:700;color:#172b4d;}.kpi-label{font-size:12px;color:#64748b;margin-top:4px;}.footer{margin-top:40px;padding-top:12px;border-top:1px solid #e2e8f0;font-size:11px;color:#94a3b8;}@media print{body{margin:0;}}</style></head><body>'
      + '<h1>ExpenseFlow — ' + title + '</h1>'
      + '<p style="color:#64748b;">' + genLabel + ' ' + dateStr + '</p>'
      + '<div class="kpi-row"><div class="kpi"><div class="kpi-value">' + formatMoney(totalSpend) + '</div><div class="kpi-label">' + t('dash_total_spend') + '</div></div><div class="kpi"><div class="kpi-value">' + filtered.length + '</div><div class="kpi-label">' + t('dash_count') + '</div></div><div class="kpi"><div class="kpi-value">' + (filtered.length ? formatMoney(totalSpend / filtered.length) : '0 €') + '</div><div class="kpi-label">' + t('dash_avg_expense') + '</div></div></div>'
      + '<h2>' + t('dash_by_category') + '</h2>'
      + '<table><thead><tr><th>' + t('category') + '</th><th style="text-align:right;">' + t('total_amount') + '</th></tr></thead><tbody>' + catRows + '</tbody></table>'
      + '<h2>' + detailTitle + '</h2>'
      + '<table><thead><tr><th>' + t('date') + '</th><th>' + t('provider') + '</th><th>' + t('category') + '</th><th style="text-align:right;">' + t('total_amount') + '</th><th>Estado</th></tr></thead><tbody>' + expRows + '</tbody></table>'
      + '<div class="footer">ExpenseFlow Schaeffler · ' + footerText + '</div>'
      + '<script>setTimeout(function(){window.print();},300);<\/script>'
      + '</body></html>';

    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const win = window.open(url, '_blank');
    if (!win) {
      // Popup blocked — fallback to download
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ExpenseFlow_Report_' + new Date().toISOString().split('T')[0] + '.html';
      a.click();
      showToast(currentLang === 'es' ? 'Informe descargado — ábrelo y pulsa Ctrl+P para PDF' : 'Report downloaded — open it and press Ctrl+P for PDF', 'success');
    }
    setTimeout(() => URL.revokeObjectURL(url), 10000);
  } catch (err) {
    console.error('PDF export error:', err);
    showToast(currentLang === 'es' ? 'Error al generar informe' : 'Error generating report', 'error');
  }
}

// ===============================================
// DEMO DATA GENERATOR
// ===============================================
function generateDemoData() {
  const now = new Date();
  const demo = [];

  const providers = {
    comida: [
      { name: 'Restaurante El Fogón', min: 12, max: 48 },
      { name: 'Cafetería Aroma', min: 4, max: 15 },
      { name: 'La Tasca de Juan', min: 18, max: 55 },
      { name: 'Telepizza', min: 10, max: 25 },
      { name: 'Goiko Grill', min: 14, max: 32 },
      { name: 'Starbucks', min: 4, max: 9 },
      { name: 'Restaurante Casa Lucio', min: 25, max: 65 },
      { name: 'Bar El Rincón', min: 8, max: 22 },
    ],
    transporte: [
      { name: 'Cabify', min: 8, max: 35 },
      { name: 'Uber', min: 6, max: 28 },
      { name: 'Renfe AVE', min: 35, max: 120 },
      { name: 'Iberia', min: 85, max: 320 },
      { name: 'Vueling', min: 45, max: 180 },
      { name: 'Taxi Madrid', min: 10, max: 40 },
    ],
    hotel: [
      { name: 'NH Collection Madrid', min: 85, max: 145 },
      { name: 'AC Hotel Barcelona', min: 95, max: 160 },
      { name: 'Ibis Budget Sevilla', min: 45, max: 72 },
      { name: 'Meliá Valencia', min: 90, max: 135 },
      { name: 'Parador de Toledo', min: 110, max: 175 },
    ],
    combustible: [
      { name: 'Repsol - E.S. Alcobendas', min: 35, max: 75 },
      { name: 'Cepsa - A-2 km 34', min: 30, max: 70 },
      { name: 'BP - Tres Cantos', min: 40, max: 80 },
      { name: 'Shell - M-40', min: 25, max: 65 },
    ],
    parking: [
      { name: 'EMPARK Barajas T4', min: 8, max: 28 },
      { name: 'Saba - Pº Castellana', min: 5, max: 18 },
      { name: 'Parking Atocha', min: 12, max: 24 },
    ],
    peaje: [
      { name: 'Autopista AP-7 Tarragona', min: 8, max: 22 },
      { name: 'AP-68 Bilbao-Zaragoza', min: 12, max: 28 },
      { name: 'Túnel de Guadarrama', min: 4, max: 6 },
    ],
  };

  const statuses = ['approved', 'approved', 'approved', 'pending', 'pending', 'draft', 'rejected'];
  const payments = ['tarjeta_corp', 'tarjeta_corp', 'tarjeta_corp', 'tarjeta_propia', 'efectivo'];
  const vatRates = { comida: 10, transporte: 10, hotel: 10, combustible: 21, parking: 21, peaje: 21 };

  // Generate 6 months of data
  for (let monthOffset = 0; monthOffset < 6; monthOffset++) {
    const month = new Date(now.getFullYear(), now.getMonth() - monthOffset, 1);
    // More expenses in recent months
    const count = monthOffset === 0 ? 12 : monthOffset === 1 ? 10 : 6 + Math.floor(Math.random() * 4);

    for (let i = 0; i < count; i++) {
      const cats = Object.keys(providers);
      // Weighted category selection (more food and transport)
      const weights = [35, 25, 12, 15, 8, 5];
      let r = Math.random() * 100;
      let catIdx = 0;
      for (let w = 0; w < weights.length; w++) {
        r -= weights[w];
        if (r <= 0) { catIdx = w; break; }
      }
      const category = cats[catIdx];
      const provList = providers[category];
      const prov = provList[Math.floor(Math.random() * provList.length)];

      const day = 1 + Math.floor(Math.random() * 27);
      const date = new Date(month.getFullYear(), month.getMonth(), day);
      if (date > now) continue; // Don't generate future dates

      const total = +(prov.min + Math.random() * (prov.max - prov.min)).toFixed(2);
      const rate = vatRates[category] || 10;
      const vat = +(total - total / (1 + rate / 100)).toFixed(2);

      demo.push({
        id: Date.now().toString(36) + Math.random().toString(36).substr(2, 6) + i,
        provider: prov.name,
        date: date.toISOString().split('T')[0],
        category: category,
        total: total,
        vat: vat,
        vatRate: String(rate),
        payment: payments[Math.floor(Math.random() * payments.length)],
        notes: '',
        status: monthOffset < 2 ? statuses[Math.floor(Math.random() * statuses.length)] : 'approved',
        image: null,
        createdAt: date.toISOString(),
      });
    }
  }

  // Sort by date descending
  demo.sort((a, b) => new Date(b.date) - new Date(a.date));
  return demo;
}

function loadDemoIfEmpty() {
  if (expenses.length === 0) {
    expenses = generateDemoData();
    saveExpenses();
  }
}

// ===============================================
// INIT
// ===============================================
function init() {
  currentLang = localStorage.getItem('lang') || 'es';
  applyLang();
  updateGreeting();
  //loadDemoIfEmpty();
  renderExpenses();
  // Load cloud sync settings
  document.getElementById('settingsEmail').value = localStorage.getItem('userEmail') || '';
  document.getElementById('settingsFlowUrl').value = localStorage.getItem('flowUrl') || '';
  updateSyncStatus();
  // Don't auto-retry on load — user can manually retry from settings
  // setTimeout(retrySyncAll, 3000);
  document.getElementById('settingsOcrUrl').value = localStorage.getItem('ocrUrl') || '';
}

init();
</script>

</body>
</html>
